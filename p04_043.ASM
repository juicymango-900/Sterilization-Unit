#make_bin#

#LOAD_SEGMENT=FFFFh#
#LOAD_OFFSET=0000h#

#CS=0100h#
#IP=03feh#

#DS=0100h#
#ES=0100h#

#SS=0100h#
#SP=9FFFh#

#AX=0000h#
#BX=0000h#
#CX=0000h#
#DX=0000h#
#SI=0000h#
#DI=0000h#
#BP=0000h#


         jmp     st1 
         db     509 dup(0)

;IVT entry for 80H
         

         dw     0000
         db     508 dup(0)
;main program
; intialize ds, es,ss to start of RAM  
st1:  cli
          mov       ax,0200h
          mov       ds,ax
          mov       es,ax
          mov       ss,ax
          mov       sp,0FFFEH
          
MOV AL,92H
OUT 06H,AL			;config 8255
MOV AL,00110100B	;config 8254 (Counter 0, Mode 2)
OUT 0Eh,AL
MOV AL,64H			;08H – 2710h(10,000)
OUT 08H,AL
MOV AL,00H			;08H – 2710h(10,000)
OUT 08H,AL

MOV AL,01110010B	;config 8254 (Counter 1, Mode 1)
OUT 0Eh,AL
MOV AL,0Ch			;0Ah – 78h(120)
OUT 0Ah,AL
MOV AL,00H			;0Ah – 78h(120)
OUT 0Ah,AL
MOV AL,10110110B	;config 8254 (Counter 2, Mode 3)
OUT 0Eh,AL
MOV AL,64H			;0Ch( To be given to SOC) – 064h(100)
OUT 0Ch,AL
MOV AL,00H			
OUT 0Ch,AL 


IR1:
IN AL,02h			; (PB 0 – IR Sensor)
AND AL,01H
JNZ IR1

MOV CL,0
MOV AL,00000000B	;( PC4- GATE1 =0)
OUT 04H,AL
MOV AL,00000000B	;( PC1- heater =0)
OUT 04H,AL  



START:		
IN AL, 00h
CMP AL,38			; Maintaining Temperature= 30 degrees
JGE X1
MOV AL,00000010b	;Heater(PC 1) on
OUT 04H,AL
JMP START

X1:
MOV AL,00000000b	;Heater(PC 1) off
OUT 04H,AL

GETLEVEL:
IN AL,02H
MOV AH,AL
AND AH,01000000B
JNZ LVL3
MOV CL,04H
JMP END10
LVL3:
MOV AH,AL
AND AH,00010000B
JNZ LVL2
MOV CL,03H
JMP END10
LVL2:
MOV AH,AL
AND AH,00001000B
JNZ LVL1
MOV CL,02H
JMP END10
LVL1:
MOV AH,AL
AND AH,00001000B
MOV CL,01H
END10:

IN AL,02h	
MOV AH,AL
AND AH,80H
;CMP AH,80H			;80h = sterlize
JZ STER
MOV AH,AL 
AND AH,20H	
;CMP AH,20H			;20H=END
JZ END1
JMP START

END1:				;end pressed

CALL DELAY_20MS		;de-bounce


IN AL,02h 
AND AL,20H
;CMP AL,20H
JNZ START

MOV AL,10110110B	;config 8254 (Counter 2, Mode 3) "reinitialize for adc "
OUT 0Eh,AL
MOV AL,64H			;0Ch( To be given to SOC) – 064h(100)
OUT 0Ch,AL
MOV AL,00H			
OUT 0Ch,AL 
MOV AL,01110010B	;COUNTER 1 MODE 1	
OUT 0Eh,AL
MOV AL,03H			; COUNT =3 (3 sec)
OUT 0Ah,AL
MOV AL,00H
OUT 0Ah,AL

MOV AL,00010000B 	;  PULSE TO GATE 1 (PC4)
OUT 04H,AL
NOP;??
NOP
MOV AL,00000000B	;PULSE
OUT 04H,AL
 
DOOR:
MOV AL,00100000B
OUT 04H,AL			;Switching motor on( PC 5)
IN AL,02h			;OUT 1 (PB1) 
AND AL,02H
JZ DOOR

MOV AL,00000000B	;Switching motor off( PC 5)
OUT 04H,AL

JMP IR1

STER:				;sterilize pressed
 
CALL DELAY_20MS		;de-bounce
IN AL,02h 
AND AL,80H
;CMP AL,80H
JNZ START
MOV AL,10000000b	;lock door( PC 7)/ STATUS ON
OUT 04H,AL

X5:
MOV AL,10000010b	; HEATER (PC 1)-ON
OUT 04H,AL


WAIT1: IN AL, 00h
CMP AL,102			; Waiting for 80 degree Celsius ???
JLE WAIT1


MOV AL,10010010B 	;  PULSE TO GATE 1 (PC4)
OUT 04H,AL
NOP
NOP
MOV AL,10000010B	;PULSE
OUT 04H,AL

TEMP100: 
IN AL, 00h
CMP AL,102			; Mantaining Temperature=80 degrees
JLE HTRON
MOV AL,10000000b	;Heater(PC 1) oFF
OUT 04H,AL  


NOP				;NOP given to calibrate heater's rate of cooling with heating
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP

HTRON:
MOV AL,10000010b	;Heater(PC 1) on
OUT 04H,AL

IN AL,02h			;OUT 1 (PB1) 
AND AL,02H
CMP AL,0
JZ TEMP100

MOV AL,01110010B	;COUNTER 1 MODE 1	
OUT 0Eh,AL
CMP CL,1			;Count of level button
JZ S1
CMP CL,2
JZ S2
CMP CL,3
JZ S3
CMP CL,4
JZ S4


S1:
MOV AL,120			;COUNT =120 (2 MIN)
OUT 0Ah,AL
MOV AL,00H
OUT 0Ah,AL
MOV AL,10010000B 	;PULSE TO GATE 1 (PC4)
OUT 04H,AL
NOP
NOP
MOV AL,10000000B 	;PULSE
OUT 04H,AL
FAN1:
MOV AL,10001000B	;Switching motor on (PC 3)
OUT 04H,AL
IN AL,02h			;OUT 1 (PB1) 
AND AL,02H
JZ FAN1
JMP OUT1
S2:
MOV AL,10110100B 	;COUNTER 2, MODE 2
OUT 0Eh,AL
MOV AL,02H			;GIVEN COUNT 2 (Duty cycle:50%)??
OUT 0Ch,AL
MOV AL,00H
OUT 0Ch,AL
MOV AL,0f0H			; COUNT =240 (4 MIN)
OUT 0Ah,AL
MOV AL,00H
OUT 0Ah,AL
MOV AL,10010000B 	;  PULSE TO GATE 1 (PC4)
OUT 04H,AL
NOP
NOP
MOV AL,10000000B	;PULSE
OUT 04H,AL
FAN2:
MOV AL,10001000B	;Switching motor on (PC 3)
OUT 04H,AL
IN AL,02h			;OUT 1 (PB1) 
AND AL,02H
CMP AL,0
JZ FAN2
JMP OUT1
S3:
MOV AL,10110100B 	;COUNTER 2, MODE 2
OUT 0Eh,AL
MOV AL,03H			;GIVEN COUNT 3 (Duty cycle:33%)
OUT 0Ch,AL
MOV AL,00H
OUT 0Ch,AL
MOV AL,68H			; COUNT =360 (6 MIN)
OUT 0Ah,AL
MOV AL,01H
OUT 0Ah,AL
MOV AL,10010000B 	;  PULSE TO GATE 1 (PC4)
OUT 04H,AL
NOP
NOP
MOV AL,10000000B	;PULSE
OUT 04H,AL
FAN3:
MOV AL,10001000B	;Switching motor on (PC 3)
OUT 04H,AL
IN AL,02h			;OUT 1 (PB1) 
AND AL,02H
CMP AL,0
JZ FAN3
JMP OUT1
S4:
MOV AL,10110100B 	;COUNTER 2, MODE 2
OUT 0Eh,AL
MOV AL,04H			;GIVEN COUNT 4 (Duty cycle:25%)
OUT 0Ch,AL
MOV AL,00H
OUT 0Ch,AL
MOV AL,0e0H			; COUNT =480 (8 MIN)
OUT 0Ah,AL
MOV AL,01H
OUT 0Ah,AL
MOV AL,10010000B 	;  PULSE TO GATE 1 (PC4)
OUT 04H,AL
NOP
NOP
MOV AL,10000000B	;PULSE
OUT 04H,AL
FAN4:
MOV AL,10001000B	;Switching motor on (PC 3)
OUT 04H,AL
IN AL,02h			;OUT 1 (PB1) 
AND AL,02H
CMP AL,0
JZ FAN4
JMP OUT1

OUT1:
MOV AL,10000000B	;Switching motor off (PC 3)
OUT 04H,AL
MOV AL,00000000b	;Unlock door( PC 7)/ STATUS OFF
OUT 04H,AL
MOV AL,10110110B	;config 8254 (Counter 2, Mode 3)
OUT 0Eh,AL
MOV AL,0E8H			;0Ch( To be given to SOC) – 03E8h(1000)
OUT 0Ch,AL
MOV AL,03H			;0Ch( To be given to SOC) –03E8h(1000)
OUT 0Ch,AL
JMP START


DELAY_20MS PROC NEAR	;subroutine
MOV DX,CX
MOV CX,10
X2:
NOP
NOP
LOOP X2
MOV CX,DX
RET
DELAY_20MS ENDP